import os
import logging
# Assume 'AllProfiles' is a module containing connection objects
# Assume 'set_conn' is a function for setting up connections
# Replace with actual imports/definitions as needed for your environment

# Configure logging (example)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

class ETLConfigManager:
    """
    Manages environment and process-specific configurations for an ETL job.
    """
    def __init__(self, process_name):
        self.process_name = process_name
        self.config_vars = {}
        self.env_name = None
        self.db_link = None
        self.etlf_db_name = None
        self.stage_path = None
        self.connections = {} # To hold connection objects like sf_cur, ora_cur, etc.

    def _determine_environment(self):
        """
        Determines environment and sets related attributes based on SCRIPT_PATH.
        """
        script_path = os.environ.get('SCRIPT_PATH', '')

        if script_path == '/talend-data/prod/idr/scripts/UnixScripts/':
            self.env_name = 'PROD'
            self.etlf_db_name = 'IDMPROD'
            self.stage_path = '/talend-data/prod/idr/stage/'
        elif script_path == '/talend-data/qa/idr/scripts/UnixScripts/':
            self.env_name = 'QA'
            self.etlf_db_name = 'IDMQA'
            self.stage_path = '/talend-data/qa/idr/stage/'
        elif script_path in [
            '/talend-data/dev/idr/scripts/UnixScripts/',
            '/data/IDR/SBX/scripts/',
            '/talend-data/scripts/IDR/OnPrem/'
        ]:
            self.env_name = 'DEV'
            self.etlf_db_name = 'IDMDEV'
            self.db_link = '@idwprdl' # Example of DEV-specific link
            self.stage_path = '/talend-data/dev/idr/stage/'
        else:
            self.env_name = 'UNKNOWN'
            logging.warning(f"Unknown SCRIPT_PATH: {script_path}")

        logging.info(f"Environment determined as: {self.env_name}")
        
    def _initialize_connections(self):
        """
        Initializes database connections using the determined environment.
        (Mocks the set_conn and AllProfiles import)
        """
        try:
            # Placeholder for actual connection logic
            # set_conn(self.env_name) 
            from AllProfiles import ora_cur, sf_cur, sf_cur1, sf_cur_util 
            
            self.connections = {
                'ora_cur': ora_cur,
                'sf_cur': sf_cur,
                'sf_cur1': sf_cur1,
                'sf_cur_util': sf_cur_util,
                # Add other connection objects here
            }
            logging.info(f"Initialized connections. Using sf_cur_util: {self.connections.get('sf_cur_util')}")
        except ImportError:
            logging.error("Could not import connection profiles from AllProfiles.")
            # Handle connection failure gracefully

    def _fetch_config_from_db(self):
        """
        Executes the main SQL query to retrieve process-specific configuration.
        """
        sf_cur1 = self.connections.get('sf_cur1')
        if not sf_cur1:
            logging.error("sf_cur1 connection cursor is not available.")
            return

        cmd = f"""
            SELECT 
                TO_VARCHAR(config_details.DESCRIPTION), 
                TO_VARCHAR(NVL(config_details.EMAIL_DMID_DETAILS, '')), 
                -- ... (rest of the configuration columns) ...
                TO_VARCHAR(config_details.EMAIL_LIST) 
            FROM idrdm.sf_idh_config_json 
            WHERE process_name='{self.process_name}';
        """
        
        try:
            sf_cur1.execute(cmd)
            result = sf_cur1.fetchone() # Assuming the query returns a single row
            
            if result:
                # Map query result to config_vars dictionary (simplified)
                # In a real scenario, you would map all 16 columns explicitly.
                self.config_vars = {
                    'autosys_job_names': result[0], # r[0]
                    'description': result[1],       # r[1]
                    'email_list': result[15] if len(result) > 15 else None, # r[15]
                    # ... map remaining values
                }
                logging.info(f"Configuration fetched for process: {self.process_name}")
            else:
                logging.warning(f"No configuration found for process: {self.process_name}")

        except Exception as e:
            logging.error(f"Error executing config query: {e}")

    def _fetch_smtp_server(self):
        """
        Fetches the SMTP mail server from the system parameter table.
        """
        sf_cur1 = self.connections.get('sf_cur1')
        if not sf_cur1:
            return

        cmd = f"""
            SELECT param_str_data
            FROM idrstg.etlf_system_parameter
            WHERE param_name = 'EMAILHOST'
        """
        try:
            sf_cur1.execute(cmd)
            result = sf_cur1.fetchone()
            if result:
                self.config_vars['smtp_mail_server'] = result[0]
                logging.info("SMTP mail server fetched.")
        except Exception as e:
            logging.error(f"Error fetching SMTP server: {e}")

    def _adjust_email_list(self):
        """
        Applies environment-specific overrides to the email list.
        """
        current_email_list = self.config_vars.get('email_list')

        if current_email_list is None:
            self.config_vars['email_list'] = "InvestmentsSnowflakeSupport@corebridgefinancial.com"
            logging.info("Default email list set (None check).")
        
        # Override based on environment after fetching from DB
        if self.env_name == 'QA':
            self.config_vars['email_list'] = "InvestmentsSnowflakeSupport@corebridgefinancial.com"
            logging.info("QA environment email list override applied.")
        elif self.env_name == 'DEV':
            # Note: The original code used a hardcoded string with commas.
            self.config_vars['email_list'] = "ravikumar.vommina@corebridgefinancial.com,kalyana.gude@corebridgefinancial.com,krishna.raja@corebridgefinancial.com"
            logging.info("DEV environment email list override applied.")
        # 'PROD' uses the list fetched from the database (or the default if DB list was None)

    def retrieve_all_config(self):
        """
        The main method to execute the entire configuration retrieval workflow.
        """
        logging.info(f"Starting config retrieval for process: {self.process_name}")
        
        self._determine_environment()
        self._initialize_connections()
        self._fetch_config_from_db()
        self._fetch_smtp_server()
        self._adjust_email_list()

        logging.info("Configuration retrieval complete.")
        return self.config_vars

# --- Usage Example ---
if __name__ == '__main__':
    # Set the environment variable for testing (optional)
    # os.environ['SCRIPT_PATH'] = '/talend-data/qa/idr/scripts/UnixScripts/'
    os.environ['SCRIPT_PATH'] = '/talend-data/dev/idr/scripts/UnixScripts/'
    
    # 1. Instantiate the class (creates an object)
    config_manager = ETLConfigManager(process_name='MY_ETL_PROCESS_NAME')
    
    # 2. Call the main method
    config_data = config_manager.retrieve_all_config()
    
    # 3. Access the retrieved configuration data
    print("\n--- Final Retrieved Configuration ---")
    print(f"Environment: {config_manager.env_name}")
    print(f"Email List: {config_data.get('email_list')}")
    print(f"SMTP Server: {config_data.get('smtp_mail_server')}")
    # print(f"All Config: {config_data}")
